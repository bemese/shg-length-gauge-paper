\documentclass[floatfix,prb,aps,superscriptaddress,11pt,preprint,letterpaper]{revtex4}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{graphicx}
\allowdisplaybreaks[1]%biutiful equation breaker!!!
\usepackage{ulem}
\usepackage{subfigure}
%\input{/Users/bms/util/definitions}
\def\chon{red}
\def\nicolas{red}
\input{definitions}
\usepackage{bm}
%%%%*****************%%%% fine hyperef 
\usepackage[backref,pdffitwindow,colorlinks,linkcolor={blue},citecolor={red}]{hyperref}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\usepackage{showlabels}
%\usepackage{showkeys}

%%%
% notes:
% check for tense consistency
% Local fields?
%%%

\begin{document}

\title{Theory of surface second-harmonic generation for semiconductors
including effects of nonlocal operators}
\author{Sean M. Anderson}
\affiliation{Centro de Investigaciones en Optica, Le\'on, Guanajuato, M\'exico}
\author{Nicolas Tancogne-Dejean}
\affiliation{Laboratoire des Solides Irradi\'es, \'Ecole 
  Polytechnique, CNRS, CEA/DSM, 91128 Palaiseau, France}
\affiliation{European Theoretical Spectroscopy Facility (ETSF), Palaiseau, France}
\author{Bernardo S. Mendoza}\email{bms@cio.mx}
\affiliation{Centro de Investigaciones en Optica, Le\'on, Guanajuato, M\'exico}
\author{Val\'erie V\'eniard}
\affiliation{Laboratoire des Solides Irradi\'es, \'Ecole 
  Polytechnique, CNRS, CEA/DSM, 91128 Palaiseau, France}
 \affiliation{European Theoretical Spectroscopy Facility (ETSF), Palaiseau, France}

\begin{abstract}
We formulate a theoretical approach of surface second-harmonic generation 
from semiconductor surfaces based on the length gauge. 
Within the independent particle approximation 
the nonlinear second-order surface susceptibility tensor
$\chi^{\mathrm{a}\mathrm{b}\mathrm{c}}(-2\omega;\omega,\omega)$   
is calculated, including for the first time in one unique formulation
i) the scissors correction, needed to have the correct value of the
energy band gap,
ii) the derivation for the inclusion of the cut function, 
used to extract the surface nonlinear response,
and iii) the contribution of the nonlocal part of the 
pseudopotentials, routinely  used in \textit{ab initio} band structure calculations. 
First and third terms are described by spatially nonlocal quantum
mechanical operators and are fully taken into account in the present formulation. 
As a test-case of the approach we calculate 
$\chi^{xxx}(-2\omega;\omega,\omega)$ for the clean Si(001)$2\times 1$
reconstructed surface and find that our scheme to extract the surface
through the cut function
readily works and is exact. The effects of the scissors correction and
of the nonlocal part of the pseudopotentials are discussed for the
first time in surface nonlinear optics. 
The scissors correction shifts the spectrum to 
higher energies though the shifting is not rigid and mixes the 
$1\omega$ and $2\omega$ resonances, 
and has a strong influence in the line-shape. 
The 
effects of the nonlocal part of the pseudopotentials 
keeps the same line-shape of $|\chi^{xxx}_{2\times 1}(-2\go;\go,\go)|$, but 
reduces its value
by 15-20\%.  
Therefore, the inclusion of the three aforementioned 
contributions is very important and 
makes our scheme unprecedented and opens the possibility to 
study SSHG with more versatility and providing more accurate results 
than previous approaches. 
\end{abstract}  

\maketitle
%\tableofcontents

\section{Introduction}\label{intro}

In recent years surface nonlinear optical spectroscopies, particulary surface 
second-harmonic generation (SSHG), have evolved as useful nondestructive 
and noninvasive tools to study surface and interface properties. These 
properties include atomic structure, phase transitions, adsorption of 
atoms, and many others.\cite{daumPRL93, mcgilpOE94, meyerPRL95, powerPRL95, 
godefroyAPL96, hoferAPA96, dadapPRB97, bloembergenAPB99, mcgilpSRL99, 
suzukiAPB99, mitchellSS01, hughesPRB96, guyotPRB88, downerPSSA01, shenAPB99, 
shenNAT89, chenPRL81, mendozaPRL98, downerSIA01} Nowadays, SSHG spectroscopy 
is a crucial tool for research and development in microelectronics,
\cite{zheltikovLP00} semiconductors, \cite{lupkeSSR99} nanomaterials,
\cite{salazar-aparicioPRB14} and many more recent areas of great scientific 
and commercial interest.\cite{cazzanelliNM14} The high surface sensitivity 
of SSHG spectroscopy is due to the fact that within the dipole approximation 
the bulk SHG signal of centrosymmetric materials is identically zero. 
Radiation can occur only at the surface where the inversion symmetry is 
broken. Much of the foundation of surface science has been built from 
experiments involving emission or scattering of electrons from surfaces. 
These require ultrahigh vacuum (UHV) environments and provide no access to 
buried interfaces. However, SSHG is compatibile with non-UHV conditions and 
has access to interfaces buried beneath transparent overlayers. Even when 
applied to surfaces in UHV, the light source and detectors can be aligned and
used outside the vacuum chamber. 

The usefulness of SSHG could be limited by the lack of microscopic theoretical
understanding of the nonlinear spectra. The macroscopic phenomenological 
theory of SSHG, which relates the intensity, phase, and polarization of 
detected fields to nonlinear and linear susceptibilities at the material 
interface is now fully developed. However, microscopic theory that relates 
atomic-level structure to the nonlinear source polarization is still being 
developed. In this article we put forward an approach to calculate the
microscopic second-harmonic surface susceptibility that encompasses several
theoretical features not taken into account before. Within the independent 
particle approximation (IPA) some frameworks for bulk SHG have been developed 
to study the nonlinear optical response of bulk materials with varying degrees 
of sophistication.\cite{butcherPOPS63, aspnesPRB72, sipePRB93, levinePRB94,
aversaPRB95, hughesPRB96, rashkeevPRB98} 

The most used framework for \textit{ab initio} calculations, Density 
Functional Theory (DFT) within the Local Density Approximation (LDA),
\cite{kohnPR65} underestimates the energy band gap of semiconductors. It is 
well understood that one has to include the many-body interaction to correct 
for this underestimation of the gap. In this context, the so-called GW 
approximation\cite{onidaRMP02} is known to correct the band gap of most 
semiconductors\cite{luceroJPCM12}. However this can be a very expensive
calculation and thus one uses the much simpler scissors operator scheme.
\cite{levinePRL89,levinePRL91,delsolePRB93}  
This allows us to ``open'' the DFT-LDA gap to 
its correct experimental or GW value even when experiments are not available. 
In this context, to correct for the underestimation of the energy band gap of 
semiconductors Nastos et al.\cite{nastosPRB05} used the ``length gauge'' or 
``$\mathbf{r}\cdot\mathbf{E}$ gauge'' to show how to correctly include the 
many-body corrections through the scissors operator in the SH susceptibility.
Later, Cabellos \textit{et al}.\cite{cabellosPRB09} elaborated a derivation 
of the ``velocity gauge'' or ``$\bfA\cdot\bfv$'' gauge properly including the 
scissors operator and proved gauge invariance with respect to the length 
gauge. From these works it is clear the length gauge is a much better staring
point to obtain the surface SH (SSH) susceptibility, as will be elaborated 
in this article. However, these considerations are only valid for bulk 
semiconductors.

Concerning the optical response of surfaces and interfaces, Reining 
\textit{et al.}\cite{reiningPRB94} introduced the concept of a cut function 
in order to obtain the surface SH susceptibility tensor. This cut function 
is required since one usually uses a slab approach when treating semi-infinite 
surface systems. If the slab is centrosymmetric the susceptibility tensor will 
be identically zero. The cut function is such that it separates the nonlinear 
response for the two surfaces of the slab avoiding the destructive 
interference between them giving a finite value that one identifies with the 
SSH susceptibility tensor. If the slab is not centrosymmetric the cut function 
can be used to separate the different signals coming from either surface of 
the slab. Indeed, one of the main results of this article is to show that the 
SSH  susceptibility tensor obtained by using the cut function is correctly 
extracted from the slab. After Reining \textit{et al.},\cite{reiningPRB94}
Refs.~\onlinecite{mendozaPRL98,arzatePRB01,mendozaPRB01,mejiaPRB02,sanoPRB02}
followed 
upon this work and in particular Ref.~\onlinecite{arzatePRB01} went into a 
detailed analysis of the different contributions to the SHG spectra of a 
surface and the nuanced relationship between bulk, surface, interband, 
intraband, $1\omega$ and $2\omega$ terms, and
Ref. \onlinecite{mejiaRMF04} developed a layer-by-layer 
analysis for the nonlinear responses of semiconductor systems, within a 
tight-binding framework. This model allows for obtaining results from 
selected regions of a system including the surface. However, in these 
references the scissors operator is either excluded or incorrectly 
implemented.

Finally, DFT-LDA calculations are often based on the use of pseudopotentials.
As it will be discussed 
in this article, the presence of a nonlocal part of the
pseudopotential introduces
corrections to
the momentum operator of the electron that have to be included with care in 
the SSH susceptibility. So far, this contribution has been neglected in the 
literature.

Therefore, within the IPA the most complete approach for the calculation of 
the SSH susceptibility is one which includes i) the scissors correction, 
ii) the cut function, and iii) the contribution of the nonlocal part of the 
pseudopotential. Therefore, the goal of this paper is to derive a new 
expression within the length gauge for the SSH susceptibility tensor 
$\chi^{\mathrm{a}\mathrm{b}\mathrm{c}}(-2\omega;\omega,\omega)$ 
that include the aforementioned contributions. The inclusion of these three 
contributions makes our scheme unprecedented and opens the possibility to 
study surface SHG with more versatility and providing more accurate results 
than previous approaches. 

The paper is organized as follows. In Sec. \ref{theory} we present the 
relevant steps for deriving the surface second-order susceptibility tensor
$\chi^{\mathrm{a}\mathrm{b}\mathrm{c}}(-2\omega;\omega,\omega)$ within the 
length gauge formalism. This derivation includes the addition of the terms 
mentioned above that have been absent in previous works. Also, our 
$\chi^{\mathrm{a}\mathrm{b}\mathrm{c}}(-2\omega;\omega,\omega)$ can be used 
for a layer-by-layer analysis if desired. In Sec. \ref{results} we show the 
results of this reformulation with a study of a clean Si(001) surface with a 
$2 \times 1$ reconstruction, 
proving the correctness of our approach with a special test-case,
never exploited before.
We compare results from before and after adding 
the different nonlocal contributions. Finally, in Sec. \ref{conc} we give 
our conclusions.

\section{Theory}

\label{theory}

In this section we present the scheme used to calculate the surface second-order
nonlinear response using the length gauge formalism.
Our derivation includes the aforementioned terms not included
before for the surface nonlinear
response. 

\subsection{Perturbation approach}

We assume the IPA and neglect local field  
and excitonic effects.  
We assume a classical electromagnetic field
and quantum mechanical matter.
We can describe the system using 
%a scaled 
the one electron density
operator ${\rho}$, with which we can calculate the expectation value of a
single-particle observable $\mathcal{O}$ as 
$\langle{\cal O}\rangle=\mbox{Tr}({\rho} {\cal O}),  
\label{calo}$
with $\mathcal{O}$ the associated quantum mechanical operator and Tr
the trace. 
The density operator satisfies
$
i\hbar (d{\rho}/dt)=[H(t),{\rho}],  
\label{rho}
$
with $H(t)$ as the total single electron Hamiltonian, written as 
\begin{equation*}
H(t)=H_{0}+H_{I}(t),  
\label{ache}
\end{equation*}
where $H_{0}$ is the unperturbed time-independent Hamiltonian, and $H_{I}(t)$
is the time-dependent potential energy due to the interaction of the
electron with the electromagnetic field.
% ; $H_{0}$ has eigenvalues
% $\hbar \omega_{n}(\mathbf{k})$
% and eigenstates $| n\mathbf{k} \rangle$ (Bloch states) labeled by a band 
% index $n$ and crystal momentum $\mathbf{k}$.
To proceed with the solution of $\rho$  it is convenient to use the
interaction picture, where a unitary operator $U=\exp ({iH_{0}t/\hbar })$
transforms any operator $\mathcal{O}$ into 
$\tilde{\mathcal{O}}=U{\cal O}U^{\dagger }$. Even if $\mathcal{O}$ 
is time-independent, 
$\tilde{\mathcal{O}}$ is time-dependent through the explicit
time dependence of $U$. 
The dynamical 
equation for $\tilde{\rho}$ is 
given by
\begin{equation*}
i\hbar \frac{d\tilde{{\rho}}}{dt}=[\tilde{H}_{I}(t),\tilde{{\rho}}],  
\label{rho1}
\end{equation*}
with solution 
\begin{equation}
i\hbar \tilde{{\rho}}(t)=i\hbar \tilde{{\rho}}_{0}+\int_{-\infty }^{t}dt^{\prime }[
\tilde{H}_{I}(t^{\prime }),\tilde{\rho}(t^{\prime })],  
\label{trans}
\end{equation}
where $\tilde{\rho}_{0}=\tilde{\rho}(t=-\infty )$ is the unperturbed density matrix. We look
for the standard perturbation series solution, 
$\tilde{\rho}(t)=\tilde{\rho}^{(0)}+\tilde{\rho}^{(1)}+\tilde{\rho}^{(2)}+\cdots$,  
where the superscript denotes the order (power) with which each term depends
on the perturbation $H_{I}(t)$. From Eq.~\eqref{trans} the $N$-th order
term is 
\begin{equation}
\tilde{{\rho}}^{(N)}(t)=\frac{1}{i\hbar }\int_{-\infty }^{t}dt^{\prime }[\tilde{
H}_{I}(t^{\prime }),\tilde{\rho}^{(N-1)}(t^{\prime })].  
\label{rhop}
\end{equation}
The series is generated by the unperturbed density operator $\tilde{\rho}
^{(0)}\equiv \tilde{\rho}_{0}$, assumed to be the diagonal Fermi-Dirac distribution, 
$\langle n\mathbf{k}|\tilde{\rho}_{0}|n\mathbf{k}\rangle=f(\hbar \omega_{n}(\mathbf{k}))\equiv f_{n}$. For a
clean, cold semiconductor $f_{n}=1$ when $n$ is a valence ($v$) or
occupied band, and zero when $n$ is a conduction ($c$) or empty band.
We assume this for the remainder of the article.
The expectation values must satisfy
$
\langle{\cal O}\rangle=
\mbox{Tr}({\rho}{\cal O})
=
\mbox{Tr}(\tilde{{\rho}}\tilde{\cal O})
$.  

We will look for the expectation value of the microscopic current density, 
$\mathbf{J}$, given by 
\begin{equation}
\bfJ=\langle{\mathbf{J}}\rangle=\frac{e}{A}\mbox{Tr}({\rho}\dot{\mathbf{r}})
,
\label{pe}
\end{equation}
where $\dot{\mathbf{r}}$ is the time derivative of the position operator of the
electron with charge $e$, defined as
\begin{equation}
\mathbf{v}\equiv \dot{\mathbf{r}}=\frac{1}{i\hbar }[\mathbf{r},H_0],  
\label{mv}
\end{equation}
with $\mathbf{v}$ the velocity operator of the electron, and $A$ the
area of the unit cell. We calculate the polarization density 
$\mathbf{P}$, related to $\bfJ$ by
$\bfJ=d\mathbf{P}/dt$. For a 
perturbing electromagnetic field, $\mathbf{E}(t)=
\mathbf{E}(\omega )e^{-i\tilde{\omega} t}+c.c.$,
where $\tilde\omega=\omega+i\eta $,
and $\eta >0$ adiabatically switches on the interaction,
we write the second-order nonlinear
polarization as, 
\begin{equation}
\calp^a(2\omega)=\chi ^{abc}(-2\omega;\omega,\omega)E^{b}(\omega)E^{c}(\omega),  
\label{pshg}
\end{equation}
where $\chi^{abc}(-2\omega ;\omega ,\omega )$ is the nonlinear
susceptibility responsible for surface second-harmonic generation
(SSHG). 
The 
superscripts in Eq.~\eqref{pshg} denote Cartesian components, and if
repeated are to be summed over. Without loss of generality we can always
define $\chi^{abc}(-2\omega;\omega,\omega)$
 to satisfy intrinsic permutation
symmetry, 
$\chi^{abc}(-2\omega ;\omega ,\omega )=\chi ^{acb}(-2\omega ;\omega
,\omega )$.
% ;
% if it did not, the part that did not satisfy intrinsic permutation symmetric
% would make no contribution to the second order polarization. This part
% could be dropped since it would
% have no physical significance.

The unperturbed Hamiltonian 
is used to solve the Kohn-Sham equations\cite{kohnPR65} of Density  
Functional Theory (DFT). It is convenient to work within the Local 
Density Approximation (LDA), so we label the hamiltonian with the corresponding  
LDA superscript. Any other approximation can be used (like GGA) and our 
derivation remains the same. Then,
\begin{equation}\label{h0}
H^{\mathrm{LDA}}_{0}(\bfr,\bfp)
=\frac{p^{2}}{2m_e}+V(\bfr,\bfp)
\end{equation}
with $m_e$ the mass of the electron, $\mathbf{p}$ its canonical momentum, and 
$V$
 the periodic crystal potential, where we neglect spin-orbit terms.
To be more general in our derivation of
$\chi^{abc}(-2\omega;\omega,\omega)$, we asume
contribution as is customary for most
pseudopotentials, and then we replace $V$ with
\begin{align}\label{ps}
V^{\mathrm{ps}}(\bfr,\bfp)=V(\bfr)+V^{\mathrm{nl}}(\bfr,\bfp)
,
\end{align}
where 
$V(\bfr)$ and $V^{\mathrm{nl}}(\bfr,\bfp)$  are the local and nonlocal parts, 
 respectively.
In case of
a local potential, i.e. $V= V(\bfr)$, 
like that of all-electron schemes, 
we simply omit the contribution coming
the results that we have derived.

It is well known that the use of the LDA
leads to an underestimation of the band gap. A standard
procedure to correct for this is to
use the ``scissors approximation'', where the 
conduction bands are rigidly shifted in energy so that the band gap 
corresponds to the accepted 
experimental band gap.\cite{levinePRL89,levinePRL91,delsolePRB93} 
This is often in fairly good agreement with the GW
band gap based on a more sophisticated calculation.\cite{hybertsenPRB86}
The LDA wave functions are used since they produce band
structures with dispersion relations similar to those predicted by the GW.
Mathematically, the scissors (non-local) operator 
$S$ is added to the unperturbed or unscissored Hamiltonian $H^{\mathrm{LDA}}_{0}$ ,
\begin{equation*}
H^\gS_{0}(\bfr,\bfp)=H^{\mathrm{LDA}}_{0}(\bfr,\bfp)+S(\bfr,\bfp)
\end{equation*}
where 
\begin{equation}
S(\bfr,\bfp)=\hbar \gD\sum_{n}\int d^{3}k(1-f_{n})
|n\mathbf{k}\rangle\langle n\mathbf{k}|,
\label{hats}
\end{equation}
with $\hbar \gD$  the rigid ($\mathbf{k}$-independent) energy correction to be
applied. 
%Several properties of $S(\mathbf{r},\mathbf{p})$ are shown in the
%appendix.
The unscissored and scissored Hamiltonians satisfy 
\begin{eqnarray*}
H^{\mathrm{LDA}}_{0}(\bfr,\bfp)\psi _{n\mathbf{k}}(\mathbf{r}) &=&\hbar \omega^{\mathrm{LDA}}_{n}(\mathbf{k})\psi _{n\mathbf{k}}(\mathbf{r}),
\label{hamils} \\
H_{0}^\gS (\bfr,\bfp)\psi _{n\mathbf{k}}(\mathbf{r}) &=&\hbar \omega_{n}^\gS
(\mathbf{k})\psi _{n\mathbf{k}}(\mathbf{r}),
\end{eqnarray*}
where the scissor-shifted energies, 
$\omega_{n}^\gS(\mathbf{k})$ , are given by
\begin{equation}
\omega_{n}^\gS(\mathbf{k})=\omega^\lda_{n}(\mathbf{k})+(1-f_{n})\gD.
\label{wese}
\end{equation}
We emphasize that the scissored and unscissored Hamiltonian 
have the same eigenfunctions, where
$\psi_{n\bfk}(\bfr)=\braket{\bfr}{n\bfk}=e^{i\bfk\cdot\bfr}u_{n\bfk}(\bfr)$,
are the real space representations of the Bloch states $\ket{n\bfk}$ labelled 
by the band index $n$ and the crystal momentum $\bfk$, and $u_{n\bfk}(\bfr)$
is cell periodic. 

\subsection{Length Gauge Formalism}
To calculate the optical response 
within the Length Gauge formalism, we take the 
interaction Hamiltonian as
\begin{equation}
H_{I}(t)=-e\mathbf{r}\cdot \mathbf{E}(t).  \label{rde}
\end{equation}
The 
treatment of the position operator
$\bfr$ for extended Bloch states, $\braket{\bfr}{n\bfk}$ has 
been described in detail.\cite{adamsJCP53,blountSSP62} 
In particular, Ref.~\onlinecite{aversaPRB95} develops
the correct treatment of $\bfr$ for
the calculation of the nonlinear optical response.
$\bfr$ is split into the {\it intraband} 
($\bfr_i$) and {\it interband} ($\bfr_e$) parts, where 
$\bfr=\bfr_i+\bfr_e$. 
For $\bfr_e$ one uses
\begin{align}\label{rnminn}
\bra{n\bfk}\bfr_e\ket{m\bfk'} &=
(1-\gd_{nm})\gd(\bfk-\bfk')\bfgxi_{nm}(\bfk) 
,
\end{align}
such that $\bfr_{e,nm}=0$ for $n=m$.
From Eq.~\eqref{mv} with $H_0\to
H^\gS_0$, we obtain
\begin{align}\label{pmnrmn}
\bfr_{e,nm}(\bfk) =
\bfgxi_{nm}(\bfk)\equiv 
\bfr_{nm}(\bfk) 
&=
\frac{\bfv^\gS_{nm}(\bfk)}{i\go^\gS_{nm}(\bfk)}
\quad\quad n\notin D_m 
,
\end{align}  
where we defined
$\go^\gS_{nm}(\bfk)\equiv\go^\gS_n(\bfk)-\go^\gS_m(\bfk)$, and
$D_m$ are all the possible degenerate $m$-states. 
%We recognize that for each instance in which 
%$n\notin D_m$ or $n\ne m$, $\bfr_{nm}(\bfk)$ are interband matrix
%elements.
For the intraband part, $\bfr_i$ only appears in
commutators during the derivation of
the optical response. We use,\cite{aversaPRB95}
\begin{equation}\label{conmri3n}
\bra{n\bfk}[\bfr_i,\calo]\ket{m\bfk'}
=i\gd(\bfk-\bfk')(\calo_{nm})_{;\bfk}
,
\end{equation}  
where
\begin{equation}\label{gendevnn}
(\calo_{nm})_{;\bfk}=
\nabla_\bfk 
\calo_{n m}(\bfk) 
- 
i 
\calo_{nm}(\bfk) 
\left(
\bfgxi_{nn}(\bfk) 
-
\bfgxi_{mm}(\bfk) 
\right) 
,
\end{equation} 
is
the generalized derivative 
of the operator $\calo$. 
The vectors $\bfgxi_{nn}(\bfk)$ are defined in 
Ref.~\onlinecite{aversaPRB95} though they do not need to be 
calculated explicitly in what follows. 

Before continuing,
we derive a key result for the length gauge formulation. 
Again, using $H^\gS_0$ in
Eq.~\eqref{mv} we obtain
\begin{align}\label{vop2}
\bfv^\gS&=
\bfv 
+
\bfv^\nl 
+\bfv^S
=
\bfv^\lda 
+\bfv^S 
,
\end{align}
where we have defined 
\begin{subequations}
\begin{align}\label{ve}
\bfv 
&=\frac{\bfp}{m_e},
\\\label{vnl}
\bfv^\nl 
&=
\frac{1}{i\hbar}[\bfr,V^\nl],
\\\label{vs}
\bfv^S
&=
\frac{1}{i\hbar}[\bfr, S],
\\\label{vlda}
\bfv^\lda 
&=
\bfv 
+\bfv^\nl
,
\end{align}  
\end{subequations}
with $\bfp=-i\hbar\bfgnabla$ the canonical momentum operator, 
and using $[r^a,p^b]=i\hbar\gd_{ab}$, where $\gd_{ab}$ is the Kronecker delta.
Using Eq.~\eqref{hats} we obtain 
\begin{equation}\label{chon.2} 
\bfv^S_{nm}=i\gD f_{mn}\bfr_{nm},
\end{equation}
with $f_{nm}\equiv f_n-f_m$,
where we see that $\bfv^S_{nn}=0$. It follows that
\begin{align}\label{chon.9}
\bfv^\gS_{nm}(\bfk) 
=\frac{\go^\gS_{nm}(\bfk)}{\go^\lda_{nm}(\bfk)}
\bfv^\lda_{nm}(\bfk) 
,
\end{align}
and
 \begin{align}\label{chon.8}
\frac{\bfv^\gS_{nm}(\bfk)}{\go^\gS_{nm}(\bfk)}
&=
\frac{\bfv^\lda_{nm}(\bfk)}{\go^\lda_{nm}(\bfk)}
,
\end{align}
and from Eq.~\eqref{pmnrmn},
\begin{align}\label{chon.10}
\bfr_{nm}(\bfk) 
=
\frac{\bfv^\gS_{nm}(\bfk)}{i\go^\gS_{nm}(\bfk)}
=
\frac{\bfv^\lda_{nm}(\bfk)}{i\go^\lda_{nm}(\bfk)}
\quad\quad n\notin D_m 
. 
\end{align}
The matrix elements 
of $\bfr_{nm}(\bfk)$ are identical using either
the LDA or scissored
Hamiltonian, thus negating the need to label them.
Of course, it is more convenient to calculate them
through $\bfv^\lda_{nm}(\bfk)$ which 
includes only the contribution of 
$\bfv^\nl_{nm}(\bfk)$. These can be readily
calculated
for 
fully separable nonlocal pseudopotentials in the 
Kleinman-Bylander 
form,\cite{francesco,mottaCMS10,kleinmanPRL82,adolphPRB96}
as shown in Appendix \ref{vesnl}.
The advantage of the length gauge formalism for 
calculating linear and nonlinear optical responses 
resides in the ease with which the scissors operator
can be introduced into the calculation, also described in detail in
Nastos et al.\cite{nastosPRB05} The 
length gauge formalism for the scissored Hamiltonian can be easily worked 
out by simply using the unscissored LDA Hamiltonian,
$H_0^{\mathrm{LDA}}$,
for the unperturbed system 
with $-e\mathbf{r}\cdot \mathbf{E}(t)$ as the interaction. 
We stress that within the length gauge,
we need only replace $\omega^{\mathrm{LDA}}_{n}$ with 
$\omega_{n}^{\gS}$ at the end of the derivation
to obtain the scissored results for any 
susceptibility expression, whether linear or nonlinear. 

Following Ref.~\onlinecite{sipePRB00} we take the
matrix elements of Eq.~\eqref{rhop} with the $H_{I}(t)$ of 
Eq.~\eqref{rde}, we obtain 
$(\tilde{\rho}^{(1)}(t))_{nm}=B_{nm}^{b}E^{b}(\omega)e^{i(\omega^\gS_{nm}-\tilde\omega)t}$,
with 
\begin{equation}\label{j.1}
B_{nm}^{b}=\frac{e}{\hbar }\frac{f_{mn}r_{nm}^{b}}{\omega^\gS_{nm}-\tilde\omega},
\end{equation}
and 
\begin{eqnarray}\label{j.2}
(\tilde{\rho}^{(2)}(t))_{nm} &=&\frac{e}{i\hbar }\frac{1}{\omega^\gS_{nm}-2\tilde\omega}\bigg[
i\sum_{q }\Big(r_{nq }^{b}B_{q m}^{c}-B_{nq}^{c}r_{q m}^{b}
\Big)  
-(B_{nm}^{c})_{;k^{b}}\bigg]E^{b}(\omega)E^{c}(\omega)e^{i(\omega^\gS_{nm}-2\tilde\omega)t}
.
\end{eqnarray}
We have used the fact that for a cold semiconductor $\partial
f_{n}/\partial \mathbf{k}=0$ and thus the intraband contribution to the linear
term vanishes identically. 
%In Appendix \ref{gender} we show how the generalized derivative of 
%$(B^a_{nm})_{;k^b}$ can be obtained.
Note that the indices in Eq.~\eqref{j.2} are all different from each
other. This is due to the $f_{nm}$ factor in Eq.~\eqref{j.1}, 
and therefore $B^a_{nn}=0$. The dependence on $\bfk$ 
of all quantities is implicitly understood from 
this point forward.

\subsection{Layered Current Density}\label{cd}

% In this section, we derive the expressions for the microscopic current
% density of a given layer in the unit cell of the system.

The approach we use to study the surface of a semi-infinite
semiconductor crystal is as follows. Instead of using a
semi-infinite system, we replace it by a super-cell that 
consists of a finite
slab of atomic layers and a vacuum region (see Fig.~\ref{fslab}). This
super-cell constitutes the unit cell, and
is repeated to form a full three dimensional crystalline structure,
i.e. a repeated super-cell scheme. 
The slab itself consists of front, back, and 
sub-surface regions, and in between these
a region that is equivalent to the
bulk of the system. 
In general the surface of a crystal reconstructs or relaxes as the atoms
move to find equilibrium positions. This is due to the fact that
the otherwise
balanced forces are disrupted when the surface atoms do not find their 
partner atoms that are now absent at the slab surface.
To take the reconstruction or relaxation into account, 
we take ``surface'' to mean
the true surface of the first layer of atoms and
some of the atomic sub-layers adjacent to it.
Since the front and the back
surfaces of the slab are usually identical the total slab is
centrosymmetric. This would imply that 
$\chi^{\mathrm{slab},\rma\rmb\rmc}=0$ so we must
find a scheme 
in order to have a finite $\chi^{\rma\rmb\rmc}$ representative of the
surface. Even if the front and back surfaces of the slab 
are different, breaking the centrosymmetry and therefore giving an
overall $\chi^{\mathrm{slab},\rma\rmb\rmc}\ne 0$; we still
need a procedure to extract the front surface $\chi^{f,\rma\rmb\rmc}$
and the back surface $\chi^{b,\rma\rmb\rmc}$ from the slab
susceptibility 
$\chi^{\mathrm{slab},\rma\rmb\rmc}=\chi^{f,\rma\rmb\rmc}-\chi^{b,\rma\rmb\rmc}$.
We have omitted the frequency arguments of $\chi^{\rma\rmb\rmc}$ for 
convenience of notation.

A convenient way to accomplish the separation of the SH signal of
either surface is to introduce a ``cut function'', $\calc(z)$, which is 
usually taken to be unity over one half of the slab and zero over 
the other half.\cite{reiningPRB94}
In this case $\calc(z)$ will give the contribution of the 
side of the slab for which $\calc(z)=1$. 
As was done for the linear response,\cite{mendozaPRB06}
we can generalize this 
simple choice for $\calc(z)$ by a top-hat cut function
$\calc^\ell(z)$ that selects a given layer,
\begin{equation}
\label{sz}
\calc^\ell(z)=\Theta(z-z_\ell+\Delta_\ell^{b})  
            \Theta(z_\ell-z+\Delta_\ell^f),
\end{equation} 
where $\Theta$ is the Heaviside function. Here, $\Delta_\ell^{f/b}$
is the distance that the $\ell$-th layer extends towards the front
$(f)$ or back $(b)$ from its $z_\ell$ position. 
We take $z_\ell$ to be at the center of an atom that 
belongs to layer $\ell$, so the previous
equation would give the $\ell$-th atomic-layer 
contribution to the nonlinear optical response.
$\Delta_\ell^f+\Delta_\ell^b$ is the thickness of layer $\ell$ 
(see Fig.~\ref{fslab}).
\begin{figure}
\centering
\includegraphics[scale=.7]{images/slab}
\caption{(color on line) A sketch of the super-cell. 
The slab corresponds to the
circles representing the atoms of the system.\label{fslab}} 
\end{figure}

To introduce the
cut function $\calc(z)$ in
the calculation of $\chi^{\rma\rmb\rmc}$, we start from 
the operator for the electron current,
$\bfj(\bfr)=\frac{e}{2}\left(\bfv^\gS\ket{\bfr}\bra{\bfr}
+\ket{\bfr}\bra{\bfr}\bfv^\gS\right)$, that leads to
\begin{align}\label{jmic}
\bfj^{(N)}(\bfr,t)=\mathrm{Tr}(\bfj(\bfr)\rho^{(N)}(t))
=
\int \frac{dk^3}{8\pi^3}
\sum_{nm}
\rho^{(N)}_{nm}(\bfk;t)\bfj_{mn}(\bfk;\bfr)
,
\end{align}
where 
\begin{equation}\label{jmic3}
\bfj_{mn}(\bfk;\bfr)=
\frac{e}{2}
\left(
\bra{m\bfk}\bfv^\gS\ket{\bfr}\braket{\bfr}{n\bfk}
+
\braket{m\bfk}{\bfr}\bra{\bfr}\bfv^\gS\ket{n\bfk}
\right),
\end{equation}
are the matrix elements of the microscopic current operator.
% and we have used the fact that the matrix elements between states $\ket{n\bfk}$
% are diagonal in $\bfk$, i.e. proportional to $\gd(\bfk-\bfk')$.
Integrating the microscopic current $\mbf{j}(\mbf{r},t)$ over
the entire slab gives the averaged microscopic current density, $\bfJ(t)$. 
If we want the contribution from only one region of the unit cell 
towards the total current, we can integrate $\mathbf{j}({\mathbf r},t)$ 
over the desired region. Then the contribution 
to the current density from the
chosen region of the slab is given by
\begin{equation}\label{jsz}
\frac{1}{A}\int d^3r\, \calc(z)\, 
\mathbf{J} (\mathbf{r},t)
 \equiv \calbj^{(N)}(t),
\end{equation}
where $\calbj^{(N)}(t)$ is the $N$-th order current induced in the
region specified by $\calc(z)$.
Therefore we define
\begin{equation}\label{vcal}
e{\boldsymbol{\mathcal{V}}}^{\gS}_{mn}(\mathbf{k})
\equiv
\int d^3r\, \calc(z)\,\bfj_{mn}({\bfk};\bfr),
\end{equation}
to write the Fourier transform of Eq.~\eqref{jmic} as
\begin{equation}\label{jmac2}
\calbj^{(N)}(2\go)=\frac{e}{A}
\int \frac{dk^3}{8\pi^3}
\sum_{mn}
\calbv^{\gS}_{mn}(\mathbf{k}) 
\rho^{(N)}_{nm}(\bfk;2\go) 
, 
\end{equation}
that gives the induced microscopic current of the chosen region, to order $N$ 
in the external perturbation. 
From
Eqs.~\eqref{vcal} and \eqref{jmic3} we obtain
\begin{align}\label{intj}
{\boldsymbol{\mathcal{V}}}^{\gS}_{mn}({\mathbf k})
&=
\frac{1}{2}
\int \mathrm{d}^3 r\,
 \calc(z)
\bigg[
\langle m\mathbf{k}|\mathbf{v}^\gS | \mathbf{r}\rangle
\langle \mathbf{r} | n \mathbf k \rangle +
\langle m\mathbf{k} | \mathbf{r}\rangle
\langle \mathbf{r} | \mathbf{v}^\gS | n \mathbf k \rangle\bigg]
\nonumber\\
&=
\frac{1}{2}
\int \mathrm{d}^3 r\,
 \calc(z)
 \bigg[
\psi_{n\mathbf{k}}(\mathbf{r})
\bfv^{\gS *}\psi^*_{m\mathbf{k}}(\mathbf{r})
+ 
\psi^*_{m\mathbf{k}}(\mathbf{r})\bfv^\gS
\psi_{n\mathbf{k}}(\mathbf{r})
\bigg]
\nonumber\\
&=
\int \mathrm{d}^3 r\,
\psi^*_{m\mathbf{k}}(\mathbf{r})
\left[\frac{\calc(z) \bfv^\gS +
\bfv^\gS \calc(z)}{2}\right]
\psi_{n\mathbf{k}}(\mathbf{r})
\nonumber\\
&=
\int \mathrm{d}^3 r\,
\psi^*_{m\mathbf{k}}(\mathbf{r})
\calbv^{\gS}
\psi_{n\mathbf{k}}(\mathbf{r})
,
\end{align}
%Here an integration by parts is performed on the third term of the
%right-hand; since the $e^{-i\bfk\cdot\bfr}\psi_{n\bfk}(\bfr)$
%are periodic over the unit cell, the surface term vanishes. 
where, we used the hermitian property of $\bfv^\gS$ and defined
\begin{align}\label{nl.4}
\calbv^{\gS}
=
\frac{\calc(z) \bfv^\gS +
\bfv^\gS \calc(z)}{2}
.
\end{align} 
%where the superscript $\ell$ is inherited from $\calc(z)$.
% and we
%supress the dependance on $z$ from the increasingly crowded notation.  
We see that the replacement
\begin{align}\label{vcali}
\bfV \to \calbv=\frac{\calc(z) \bfV +
\bfV \calc(z)}{2}
,
\end{align} 
is all that is needed to change any of the
electron velocity operators $\bfV$ to the new velocity
operator $\calbv$ that implicitly takes into account the
contribution of the region of the slab given by $\calc(z)$.
We note that this modified operator is hermitian as it must.\cite{note2}
The operator $\bfV$ could be any of those given by Eq.~\eqref{vop2},
thus
\begin{align}\label{vopii}
\calbv^{\gS}
&=
\calbv^{\lda}
+
\calbv^{S}
\nonumber\\
\calbv^{\lda}
&=
\calbv
+
\calbv^{\nl}
.
\end{align}
To calculate
$\calbv^{\gS}_{nm}(\bfk)$ 
we calculate the matrix elements of 
$\calbv^{\lda}$ and $\calbv^{S}$
 (separately)
according to the expressions of
Appendices \ref{calpcalc}, \ref{vesnl} and \ref{calvs}.
If not stated differently, calligraphic letters correspond to layer quantities. 

The layer-by-layer analysis of Refs. \onlinecite{hoganPRB03,castilloPRB03,mottaCMS10}  
used $\calc(z)$
%limiting the current response  
%to a particular layer of the slab and used  
to obtain the  
anisotropic linear optical response of semiconductor surfaces, 
where, the first formal derivation  
of this scheme  
was presented in  
Ref.~\onlinecite{mendozaPRB06}. 
To limit the SHG response to one surface, Eq.~\eqref{vcali} 
for $\calbv$ was proposed in 
Ref.~\onlinecite{reiningPRB94} and later used in Refs.
\onlinecite{mendozaPRL98},
\onlinecite{mendozaPRB01},
\onlinecite{sanoPRB02},
 and \onlinecite{mejiaRMF04}. 
In this article, for the first time, we formally introduce the cut function $\calc(z)$ 
for the second-harmonic optical response of semiconductor surfaces,
from an average of the second order polarization over the region of interest.

Using
$\calbj=d\calbp/dt$ 
and Eq.~\eqref{jmac2} 
we obtain the SH polarization of a given region as
\begin{equation}\label{Pjikn}
\calbp^{(2)}(2\go)
=\frac{ie}{2A\got}
\int \frac{dk^3}{8\pi^3}
\sum_{mn}
\calbv^{\gS}_{mn}(\mathbf{k})
\rho^{(2)}_{nm}(\bfk;2\go)
,
\end{equation}
and using Eqs.~\eqref{pshg} and \eqref{j.2} 
leads to
\begin{align}\label{Pjikn2}
\chi^{\rma\rmb\rmc}(-2\go;\go,\go) 
&=
\frac{e^2}{2A\hbar\got}
\int \frac{dk^3}{8\pi^3}
\sum_{mn}
\frac{\calv^{\gS,\rma}_{mn}(\mathbf{k})}
{\go^\gS_{nm\bfk}-2\got}
\bigg[
-(B_{nm}^{\rmc}(\bfk,\go))_{;k^{\rmb}}
\nonumber \\
&
+i\sum_q\left(r_{nq}^{\rmb}B_{qm}^{\rmc}(\bfk,\go) -
  B_{nq}^{\rmc}(\bfk,\go) 
  r_{qm}^{\rmb}\right)
\bigg]
,
\end{align}
which gives the susceptibility 
$\chi^{\rma\rmb\rmc}(-2\go;\go,\go)$ 
of the layers of the slab specified by $\calc(z)$. 
We mention that the units of 
$\chi^{\rma\rmb\rmc}(-2\go;\go,\go)$
are m$^2$/V, as they should be for a surface SH susceptibility.
Using Eq.~\eqref{j.1} we
split this equation into
two contributions from the first and second terms on the right hand side
of Eq.~\eqref{Pjikn2}:
%\end{document}  
\begin{equation}\label{chii}
\chi^{\rma\rmb\rmc}_i (-2\go;\go,\go)
=-\frac{e^3}{A\hbar^22\got}
\int \frac{dk^3}{8\pi^3}
\sum_{mn}
\frac{\calv_{mn}^{\gS,\rma}}{\go^\gS_{nm}-2\got}
\left(\frac{f_{mn}r_{nm}^{\rmb}}{\go^\gS_{nm}-\got}\right)_{;k^{\rmc}}
,
\end{equation} 
related to intraband transitions, and 
\begin{equation}\label{chie}
\chi^{\rma\rmb\rmc}_e (-2\go;\go,\go)
=\frac{ie^3}{A\hbar^22\got}
\int \frac{dk^3}{8\pi^3}
\sum_{qmn}
\frac{\calv_{mn}^{\gS,\rma}}{\go^\gS_{nm}-2\got}
\left(
\frac{r_{nq}^{\rmc} r_{qm}^{\rmb} 
f_{mq}}{\go^\gS_{qm}-\got}
-\frac{r_{nq}^{\rmb} r_{qm}^{\rmc} 
f_{qn}}{\go^\gS_{nq}-\got}
\right),
\end{equation} 
related to interband transitions.
The generalized derivative in Eq.~\eqref{chii} is dealt with by the chain rule 
\begin{equation}\label{gene2}
\left(\frac{f_{mn}r_{nm}^{\rmb}}{\go^\gS_{nm}-\got}\right)_{;k^{\rmc}}=
\frac{f_{mn}}{\go^\gS_{nm}-\got}\left(r_{nm}^\rmb\right)_{;k^{\rmc}}
-\frac{f_{mn}r_{nm}^{\rmb}\gD_{nm}^\rmc}{(\go^\gS_{nm}-\got)^2}
,
\end{equation}
where substituting $H^\gS_0$ 
into Eq.~\eqref{conmri3n} and then
Eq.~\eqref{chon.9}
we obtain
\begin{align}\label{eli.13}
\left(\go^\gS_{nm}\right)_{;k^{\rma}}
=
\left(\go^\lda_{nm}\right)_{;k^{\rma}}
= 
v_{nn}^{\lda,\rma}-v_{mm}^{\lda,\rma}\equiv\gD_{nm}^{\rma}
.
\end{align} 
The apparent divergence as $\got\to 0$
in Eqs. \eqref{chii} and \eqref{chie},  
is removed  by
 a partial fraction expansion over $\got$. 
Using time-reversal invariance, an integration by parts to 
remove the square in the denominator of the second term of Eq.~\eqref{gene2}, 
and taking the limit of $\eta\to 0$, 
we obtain the following expressions for the imaginary parts of 
Eqs. \eqref{chii} and \eqref{chie}, 
\begin{subequations}\label{chis}
\begin{equation}\label{calvimchiewn}
\mathrm{Im}[\chi^{\rma\rmb\rmc}_{e,\go}]= 
\frac{\pi |e|^3}{2\hbar^2}
\int \frac{dk^3}{8\pi^3}
\sum_{vc}\sum_{q\neq(v,c)}\frac{1}{\omega^\gS_{cv}}
\left[
\frac{\mathrm{Im}[\mathcal{V}^{\gS,\mathrm{a}}_{qc}\{r^{\rmb}_{cv}r^{\rmc}_{vq}\}]}
{(2\go^\gS_{cv}-\go^\gS_{cq})} 
-\frac{\mathrm{Im}[\mathcal{V}^{\gS,\mathrm{a}}_{vq}\{r^{\rmc}_{qc}r^{\rmb}_{cv}\}]}
{(2\go^\gS_{cv}-\go^\gS_{qv})}
\right]\gd(\go^\gS_{cv}-\go),
\end{equation}  
\begin{equation}\label{calvimchiwn}
\mathrm{Im}[\chi^{\rma\rmb\rmc}_{i,\go}]= 
\frac{\pi\vert e\vert^3}{2\hbar^2}
\int \frac{dk^3}{8\pi^3}
\sum_{cv}\frac{1}{(\omega^\gS_{cv})^{2}}
\left[
\mathrm{Re}\left[\left\{r^{\mathrm{b}}_{cv}\left(\mathcal{V}^{\gS,\mathrm{a}}_{vc}\right)_{;k^{\mathrm{c}}}\right\}\right]
+\frac{\mathrm{Re}\left[\mathcal{V}^{\gS,\mathrm{a}}_{vc}\left\{r^{\mathrm{b}}_{cv}
\Delta^{\mathrm{c}}_{cv}\right\}\right]}{\omega^\gS_{cv}} 
\right]\delta(\omega^\gS_{cv}-\omega),
\end{equation}
\begin{equation}\label{calvimchie2wn}
\mathrm{Im}[\chi^{\rma\rmb\rmc}_{e,2\go}]= 
-\frac{\pi |e|^3}{2\hbar^2}
\int \frac{dk^3}{8\pi^3}
\sum_{vc}\frac{4}{\omega^\gS_{cv}}
\left[
\sum_{v'\ne
  v}\frac{\mathrm{Im}[\mathcal{V}^{\gS,\mathrm{a}}_{vc}\{r^{\rmb}_{cv'}r^{\rmc}_{v'v}\}]}
{2\go^\gS_{cv'}-\go^\gS_{cv}}
- \sum_{c'\ne
  c}\frac{\mathrm{Im}[\mathcal{V}^{\gS,\mathrm{a}}_{vc}\{r^{\rmc}_{cc'}r^{\rmb}_{c'v}\}]}
{2\go^\gS_{c'v}-\go^\gS_{cv}}
\right]\gd(\go^\gS_{cv}-2\go),
\end{equation}
\begin{equation}\label{calvimchi2wn}
\mathrm{Im}[\chi^{\rma\rmb\rmc}_{i,2\go}]= 
 \frac{\pi \vert
   e\vert^{3}}{2\hbar^2}
\int \frac{dk^3}{8\pi^3}
\sum_{vc}\frac{4}{(\omega^\gS_{cv})^{2}}
\left[\mathrm{Re}\left[\mathcal{V}^{\gS,\mathrm{a}}_{vc}\left\{\left(r^{\mathrm{b}}_{cv}\right)_{;k^{\mathrm{c}}}
\right\}\right] -
\frac{2\mathrm{Re}\left[\mathcal{V}^{\gS,\mathrm{a}}_{vc}\left\{r^{\mathrm{b}}_{cv}
\Delta^{\mathrm{c}}_{cv}\right\}\right]}{\omega^\gS_{cv}}\right]\delta(\omega^\gS_{cv}-2\omega)
,
\end{equation}
\end{subequations}
where we have split the interband and intraband $1\go$ and $2\go$
contributions and supressed the $\go$ arguments for 
convenience of notation.
The real part of each contribution can be obtained through
a Kramers-Kronig transformation\cite{nicolasPRB14} and
$\chi^{\rma\rmb\rmc}=
\chi^{\rma\rmb\rmc}_{e,\go} 
+\chi^{\rma\rmb\rmc}_{e,2\go}
+\chi^{\rma\rmb\rmc}_{i,\go} 
+\chi^{\rma\rmb\rmc}_{i,2\go}
$.
To fulfill the required intrinsic permutation symmetry, %\cite{rashkeevPRB98} 
the $\{\}$ notation symmetrizes the $\rmb\rmc$ Cartesian indices, i.e. 
$\{u^{\rmb}s^{\rmc}\}=(u^{\rmb}s^{\rmc}+u^{\rmc}s^{\rmb})/2$,
and thus
$\chi^{\rma\rmb\rmc}=\chi^{\rma\rmc\rmb}$.
The various quantities involved in Eqs.~\eqref{chis} are given in
the Appendix \ref{appe}. 
We mention that if we take $\calc(z)=1$ through out, the layered
matrix elements $\calbv^{\gS}_{nm}$ become standard bulk-like
$\bfv^{\gS}_{nm}$ matrix elements. We mention that in this
case, Eq.~\eqref{chis} is equivalent to the expressions of
Ref.~\onlinecite{cabellosPRB09}, valid for bulk semiconductors.
 
Finally, we could also calculate the nonlinear surface susceptibility as 
\begin{equation}\label{chiijksur}
\bfgchi(-2\go;\go,\go)
= \sum_{\{\ell\}}\bfgchi^\ell(-2\go;\go,\go),
\end{equation} 
where $\ell$ would denote a particular layer chosen through
$\calc^\ell(z)$ of Eq.~\eqref{sz} and
$\{\ell\}$
is meant to be a chosen set of layers. For instance, 
one can take a single layer 
encompassing half of the slab, or take each 
atomic layer individually to the middle
of the slab. For the first case there is 
a single summand
in Eq.~\eqref{chiijksur}. For the second case
there is a sum from $\ell=1$, denoting the first layer 
right at the surface, to $\ell=N$, denoting the layer at the middle of the slab 
that behaves like a bulk layer.
%that at a distance $d$ from the surface  as seen in Fig.~\ref{fslab}.  
%For a centrosymmetric slab, 
%$\bfgchi^{\ell=N}=0$;
We remark that the value of 
$N$ is not universal and
the slab needs to have enough atomic layers 
%$\bfgchi^{\ell=N}=0$;
%to be satisfied and to 
in order to give converged results for 
$\bfgchi (-2\go;\go,\go)$. 
We can use Eq.~\eqref{chiijksur} for 
either the front or the back surface. 
% This decomposition of $\bfgchi(-2\go;\go,\go)$ into
% $\bfgchi^\ell(-2\go;\go,\go)$ would allow to explore the contribution
% to SH from any particular layer of the system,
% and answers questions like: which part of the system has the strongest
% contribution? or  how deep does the surface region needs to be to
% recover centrosymmetry?, etc.
\cite{mejiaRMF04}
%\mathrextcolor{\chon}{Talk about the correct value of $d$}

\section{Results}\label{results}

In this section we present a 
relevant test case to check the
consistency of our approach. We have selected
a clean Si(001) surface with a $2\times 1$ surface reconstruction.
The slab for such a surface could be chosen to be centrosymmetric 
by creating the front and back
surfaces with the same $2\times 1$
reconstruction. However, we choose to terminate one 
of the surfaces with hydrogen producing an ideal  
terminated bulk Si surface. The H atoms simply saturate the 
dangling bonds of the bulk-like Si atoms at the surface, as seen in 
Fig.~\ref{si2x1}.
We take the $z$ coordinate pointing out of the surface and the $x$
coordinate along the crystallographic [011] direction is parallel to the dimmers. 
\begin{figure}
\centering 
\includegraphics[scale=.8]{images/si2x1-crop}
\caption{(color on line) The slab shows a 
    clean Si(001)$2\times 1$ front surface 
    with an ideal terminated Si bulk back surface. The
    dangling bonds are H (small balls) saturated. 
    This image depicts 12 Si atomic layers
    with one H atomic layer. 
\label{si2x1}} 
\end{figure} 
The idea behind this slab configuration is that the 
cristalline symmetry of the H terminated surface imposes that 
$\chi_{\mathrm{H}}^{xxx}=0$.
 The $2\times 1$ surface has no 
such restrictions, so $\chi_{2\times 1}^{xxx}\ne 0$.
This is due to the fact that along the $y$ direction there is a mirror plane for the
H-saturated surface, whereas 
for the $2\times 1$ surface this mirror is lost as the dimers are
asymmetric along $x$. 
Thus, calculating $\chi^{xxx}$ for the full-slab, or the 
half-slab containing the $2\times 1$ surface\cite{note1}
should yield the same result since the contribution from the H
saturated surface is zero regardless. 
We must check that the following 
relationship is satisfied for this particular slab
\begin{align}\label{hs}
\chi_{\mathrm{half-slab}}^{xxx}(-2\go;\go,\go) 
=
\chi_{\mathrm{full-slab}}^{xxx}(-2\go;\go,\go) 
,
\end{align}
where
$\chi_{\mathrm{half-slab}}^{xxx}(-2\go;\go,\go)$ is calculated using
$\calc(z)=1$ from the upper half containing the $2\times 1$ 
surface reconstruction, as seen in Fig.~\ref{si2x1},
and $\chi_{\mathrm{full-slab}}^{xxx}(-2\go;\go,\go)$ is calculated using
$\calc(z)=1$ through the full slab.
We show the results for this comparison in the remainder 
of this section.


The self-consistent ground state and their Kohn-Sham states were
calculated in the DFT-LDA framework using the plane-wave 
ABINIT code.\cite{abinit}
We used Troullier-Martins pseudopotentials\cite{troullierPRB91} that are 
fully separable nonlocal pseudopotentials in the Kleinman-Bylander 
form.\cite{kleinmanPRL82}
The contribution of $\bfv^\nl$ to Eq.~\eqref{chis} can be carried out 
as detailed in Appendix \ref{vesnl} using the DP code for 
the actual calculation.\cite{francesco}
%
The surfaces have been studied with a lattice constant of 5.43 \AA. 
Structural optimizations were performed using DFT-LDA
with the ABINIT code.\cite{abinit}  
The geometry optimization as been carried out in slabs of 12
atomic layers where the central four layers where fixed at the bulk
positions.  
The structures were relaxed until the Cartesian force components were less than 5 meV/\AA. 
The geometry optimization for the clean surface gives
a dimer buckling of 0.721 \AA, and a dimer length of 2.301 \AA.  
For the  Si(001)$1\times 1$:2H dihydride surface, we have obtained a Si-H bond distance of 1.48 \AA. 
This results are in good agreement with previous 
theoretical studies.\cite{caramellaPRB09,mendozaPRB06}
The vacuum size is equivalent to one quarter the
size of the slab, avoiding the effects produced by possible 
wave-function tunneling from the contiguous surfaces of the full
crystal formed by the repeated super-cell scheme.\cite{mendozaPRB06}    

Spin-orbit, local field, and electron-hole 
attraction\cite{beyond}
effects on the SHG process are all neglected.
Although these are important factors in the optical response of a semiconductor,
their efficient calculation is still theoretically and  
numerically challenging and  
under debate. This merits further study but is beyond the scope of this paper.
For a given slab size, we find the converged spectra 
to obtain the relevant parameters. The most important of 
these are: an energy cut-off of 10 Ha, an equal number of conduction and 
valence bands, and a set of 244 $\bfk$-points.
The $\bfk$-points are used for the linear analytic 
tetrahedron method for evaluating the
Brillouin zone integrals in Eq.~\eqref{chis}, 
where special care was taken to examine the double resonances.\cite{nastosPRB05}
Double resonances occur at a given frequency $\omega$ if there can be 
resonant transitions at both $\omega$ and 2$\omega$ frequencies. This 
implies that there is a region in the Brillouin zone where 
$\omega_{cv}(\bfk)=2 \omega_{c'v}(\bfk)$. Since there is a real population 
excitation, the perturbation theory used to calculate the spectrum breaks 
down at these $\bfk$-points. This must be taken into account in a more 
complete calculation. These points introduce sharp spikes in the spectrum. 
In principle, these can affect the low frequency results since the response 
is computed from the Kramers-Kronig relation for frequencies below the band 
gap. However, in agreement with Ref.~\onlinecite{nastosPRB05} we find that 
the double resonances affect the low frequency results by less than 2\%. 
All spectra were calculated with a Gaussian smearing of 0.15 eV.
\begin{figure}
\centering 
\includegraphics[scale=.8]{plots/fig1}
\caption{(color on line) 
$|\chi_{\mathrm{half-slab}}^{xxx}|$ vs $\hbar\omega$ 
for the slab
with 16, 24, 32, and 40 atomic Si layers. The front surface 
is in a clean $2\times 1$ reconstruction and the back 
surface is an ideal terminated bulk H-saturated dangling bonds (see Fig.~\ref{si2x1}).
\label{fig1}} 
\end{figure}
\begin{figure}
\centering 
\includegraphics[scale=.8]{plots/fig2}
\caption{(color on line) 
$\chi^{xxx}_{\mathrm{half-slab}}$
and 
$\chi^{xxx}_{\mathrm{full-slab}}$
vs $\hbar\omega$ for a slab with 32 
atomic Si layers plus one H layer. 
\label{fig2}} 
\end{figure}

We must evaluate 
$T^{\rma\rmb}_{nm}=(i/\hbar)[r^\rmb,v^{\nl,\rma}]_{nm}$,
as outlined in Appendix \ref{vesnl},
in order to obtain 
Eqs.~\eqref{tau.1} and \eqref{tau.1n} that are required for 
Eq.~\eqref{chis}.
Computing second-order 
derivatives is required thus making the numerical procedure very 
time consuming. This adds significantly to the already lengthy time needed 
for the calculation of the $\bfv^\nl$ contribution that is
proportional only to 
the first order derivatives. 
Memory requirements are also increased for both $\bfv^\nl$ and 
$[\bfr,\bfv^\nl]$. However, the contribution from $[\bfr,\bfv^\nl]$ 
is very small\cite{valerie} and therefore we neglect it in this work.

\subsection{Full-slab results}\label{fsresults}

In Fig.~\ref{fig1} we show $|\chi_{\mathrm{full-slab}}^{xxx}|$
for the slab with
16, 24, 32, and 40 Si atomic layers. 
In making the slabs larger, we add steps of 8 layers of bulk-like atomic positions. 
We note that the response differs substantially 
for 16 and 24 layers but is quite similar for 32 and 40 layers.
As explained above,
the calculation of the $\bfv^\nl$ contribution is 
computationally expensive.
A good compromise between the accuracy in the convergence of
$\chi^{xxx}_{\mathrm{full-slab}}$ as a function of the number
of layers in the slab, and the computational 
expense is to consider
the slab with 32 Si atomic layers as 
an accurate representation of our 
system.

\subsection{Half-slab vs. full-slab}

In Fig.~\ref{fig2}
we compare 
$\chi^{xxx}_{\mathrm{half-slab}}$  
vs. 
$\chi^{xxx}_{\mathrm{full-slab}}$ 
for the four different possibilities 
between including or not including the
effects of $\bfv^\nl$ or the scissors correction
$\hbar\gD$.   
For these results we chose
$\hbar\gD=0.5$ eV, that is the GW gap reported in
Refs.~\onlinecite{rohlfingPRB95,garciaCPC01}. 
We see that for all four instances the 
difference between responses is quite small.
Indeed, when the value $|\chi^{xxx}|$ 
is large the difference between the two is very small; 
when the value is small the difference increases only slightly, 
but the spectra is so close to zero that these it is negligible. 
These differences would decrease as the number of atomic layers 
increases. We remark that 32 layers in the slab is more than enough 
to confirm that the extraction of the surface second-harmonic 
susceptibility from the $2\times 1$ surface is readily possible 
using the formalism contained in Eq.~\eqref{chis}.
This confirms the validity of our theory and is the main result of
this article; through the proposed layer formalism we can calculate the surface SH
pseudopotentials
and the many-body effects through the scissors correction.
Our scheme should to work for any slab.  

\subsection{\texorpdfstring{Results for $\chi^{xxx}_{2\times 1}(-2\go;\go,\go)$}
{Results for Xxxx(2x1)(-2w;w,w)}}

We proceed to explain 
some of the features seen in $|\chi^{xxx}_{2\times 1}|$ that, as
explained above, are obtained 
by calculating $|\chi^{xxx}_{\mathrm{half-slab}}|$.
First, from Fig.~\ref{fig2} we note a series of resonances 
that derive from 1$\omega$ and 2$\omega$ terms in
Eq.~\eqref{chis}. 
Notice that the 
2$\omega$ resonances start below $E_g/2$ where $E_g=0.53$ eV is the LDA
band gap of this surface, and $E_g=1.03$ eV is the scissor shifted gap for
$\hbar\gD=0.5$ eV.
These resonances
come from the electronic states of the 
$2\times 1$ surface, that lie inside the bulk band gap of Si and are the 
well known electronic surface states.
In Fig.~\ref{fig3}
We see that the effect of $\bfv^\nl$
 reduces the value of   
$|\chi^{xxx}_{2\times 1}|$  
by 15-20\% 
showing the importance of this contribution for a correct calculation  
of SSHG.  
However, the inclusion of $\bfv^\nl$ does not
changes the 
spectral shape of $|\chi^{xxx}_{2\times 1}|$;
 this also can be confirmed from
the cases of zero scissors correction from Fig.~\ref{fig2}.
%
\begin{figure}
\centering 
\includegraphics[scale=.8]{plots/fig3}
\caption{(color on line) 
$\chi^{xxx}_{2\times 1}$
vs $\hbar\omega$ for a slab with 32 
atomic Si layers plus one H layer, 
with and without the contribution from $\bfv^\nl$.
\label{fig3}} 
\end{figure}

To see the effect of the scissors correction, we take two different
finite values for $\hbar\gD$. The first one
with a value of $\hbar\gD=0.5$ eV, used in above results, 
is the ``average'' GW gap taken from 
Ref.~\onlinecite{rohlfingPRB95} 
that is in agreement with Ref.~\onlinecite{garciaCPC01}. The second one
with a value of $\hbar\gD=0.63$ eV is the ``average'' 
gap taken from Ref.~\onlinecite{asahiPRB00}, 
where more $\bfk$-points in the Brillouin zone were 
used to calculate its GW value.
From Fig.~\ref{fig4}
we note that the scissors correction 
shifts the spectra from it LDA value to higher energies as expected.
 However, contrary 
to the case of linear optics\cite{cabellosPRB09} the shift introduced 
by the scissors correction is not 
rigid, as pointed out in Ref.~\onlinecite{nastosPRB05}. 
 This is because the second-harmonic optical response mixes 
$1\omega$ and $2\omega$ transitions (see Eq.~\eqref{chis}), and accounts 
for the non-rigid shift. 
When we compare 
$|\chi^{xxx}_{2\times 1}|$ for the two finite values of $\hbar\gD$,
we see that the first two peaks are almost rigidly 
shifted with a small difference in height while
the rest of the peaks are modified substantially. 
This behavior comes from the fact that the first two
peaks are almost exclusively related to the 
2$\omega$ resonances of
Eq.~\eqref{chis}. The other peaks are a combination 
of 1$\omega$ and 2$\omega$ resonances 
and yield a more varied spectrum. 
This way we see that small changes in the value of the 
scissors shift can in general affect the SSH susceptibility 
spectrum quite dramatically.
\begin{figure}
\centering 
\includegraphics[scale=.8]{plots/fig4}
\caption{(color on line) 
$\chi^{xxx}_{2\times 1}$
vs $\hbar\omega$ for a slab with 32 
atomic Si layers plus one H layer, 
for two different values of 
the scissors correction $\hbar\gD$. 
\label{fig4}} 
\end{figure}

Although local fields are neglected they should, in principle, 
be small parallel to the interface as the electric field is continuous.
So, we would expect that the $xxx$ component of 
$\bfgchi(-2\go;\go,\go)$ would have a small influence from the local fields.
Unfortunately the experimental measurement of the $xxx$
component of $\bfgchi(-2\go;\go,\go)$ is not possible as the SH 
radiated intensity would be proportional not only to this component 
but also to the other components of $\bfgchi(-2\go;\go,\go)$.  
However,
in a forthcoming publication 
we will present a study of SSHG from several 
Si surfaces 
with comparison to experimental 
results. 

\section{Conclusions}\label{conc}

We have presented a formulation to calculate the surface second-harmonic
(SSH) susceptibility tensor $\bfgchi(-2\go;\go,\go)$, using the length gauge
formalism and within the independent particle approximation (IPA).
It includes on equal footing and for the first time in the literature: 
i) the scissors correction, ii) the cut function, and iii) the
contribution of the non-local part of the pseudopotentials.
We have used a Si(001)$2\times 1$ surface to confirm that our scheme
correctly obtains the surface response as we confirm
that 
$\chi_{\mathrm{half-slab}}^{xxx}(-2\go;\go,\go) 
\approx
\chi_{\mathrm{full-slab}}^{xxx}(-2\go;\go,\go) 
. 
$
Although one can in principle increase the number of atomic layers,
$\bfk$-points, etc. to
improve even further on the similarity of the half-slab and full-slab results, we
have chosen a good compromise between accuracy and the burden and time
of the computations. 
We describe the effect of the independent inclusion of the three
effects mentioned above in the calculation of  
$\bfgchi(-2\go;\go,\go)$. 
The scissors correction shifts the spectrum to  
higher energies though the shifting is not rigid and mixes the 
$1\omega$ and $2\omega$ resonances,  
and has a strong influence in the line-shape.
 The cut function allows us  
to extract unequivocally $\chi^{xxx}_{2\times 1}(-2\go;\go,\go)$.
 The effects of the nonlocal part of the pseudopotentials  
keeps the same line-shape of $|\chi^{xxx}_{2\times
  1}(-2\go;\go,\go)|$,
but  
reduces the value of   
by 15-20\%. 
Therefore,  
the results show the importance of these three contributions for a correct calculation 
of SSHG.
The $xxx$ component of  
$\bfgchi_{2\times 1}(-2\go;\go,\go)$, 
can not be
experimentally isolated,
however in a forthcoming publication 
we will compare our formulation 
against
experimental 
results. 
We have neglected
local field 
and excitonic effects.
Although these are important factors in the optical response of a semiconductor,
their efficient calculation is theoretically and 
numerically challenging and still 
under debate.\cite{beyond}  
This merits further study but is beyond the scope of this paper. 
Nevertheless, the inclusion of aforementioned contributions 
in
our scheme opens the unprecedented possibility to study 
surface SHG with more versatility and provides 
more accurate results than previous approaches. 

\section{Acknowledgments}


B.S.M. acknowledges the Laboratoire des Solides Irradi\'es (Ecole
Polytechnique, Palaiseau, France) for the support and hospitality
during a sabbatical year. B.S.M. acknowledges partial support from
CONACYT-M\'exico Grant 153930. 

%%%%%%%%%%%%%
\appendix 
\section{}\label{appe}
We give explicit expressions for the quantities used in the evaluation 
of Eq.~\eqref{chis}; when appropriate, some 
intermediate steps are given for their derivation. 
%%%%
\subsection{ Expressions for 
\texorpdfstring{${\calbv}_{nm}(\bfk)$}{que} 
and 
\texorpdfstring{${\cal C}_{nm}(\bfk)$}{que}
}\label{calpcalc}

Expanding the wave function in plane waves we obtain
\begin{align}\label{eni.1}
\psi_{n\bfk}(\bfr)=\sum_\bfG A_{n\bfk}(\bfG)e^{i(\bfk+\bfG)\cdot\bfr}
,
\end{align}
where $\{\bfG\}$ are the reciprocal basis vectors satisfying
$e^{\bfR\cdot\bfG}=1$, with $\{\bfR\}$ the translation vectors in real
space, and $A_{n\bfk}(\bfG)$ the expansion coefficients. Using
$m_e\bfv=\bfp=-i\hbar\bfgnabla$ into 
Eq.~\eqref{vcali}
we obtain,\cite{mendozaPRB06}
\begin{align}\label{eni.2}
\calbv_{nm}(\bfk)=
\frac{\hbar}{2m_e}
\sum_{\bfG,\bfG'} A^*_{n\bfk}(\bfG')  A_{m\bfk}(\bfG)
(2\bfk+\bfG+\bfG')
\gd_{\bfG_\parallel \bfG'_\parallel}  
f(G_\perp-G'_\perp)
,
\end{align}   
where
\begin{align}\label{vnl.9}
f(G_\perp)=\frac{1}{L}\int\calc(z) e^{iG_\perp z}dz  
 ,
\end{align}
with $f^*(G_\perp)=f(-G_\perp)$,
and $L$
is the length of the super-cell. 
The reciprocal lattice vectors $\bfG$ are 
decomposed into components
parallel ($\bfG_\parallel$), and perpendicular ($G_\perp \hat z$)
to the surface, so
that $\bfG = \bfG_\parallel + G_\perp\hat z$.
The double summation over the $\bfG$ vectors can be 
calculated efficiently by  
creating a pointer array to identify all the plane-wave coefficients  
associated with the same $G_\parallel$.  

Likewise we obtain that
\begin{align}\label{eni.4}
\calc_{nm}(\bfk)=
\sum_{\bfG,\bfG'} A^*_{n\bfk}(\bfG')  A_{m\bfk}(\bfG)
\gd_{\bfG_\parallel \bfG'_\parallel} 
f(G_\perp-G'_\perp)
.
\end{align}  
If $\calc(z)=1$, then $f(G_\perp)=\gd_{G_\perp 0}$ and we 
obtain the full-slab/bulk values, 
$\bfv_{nm}(\bfk)$ and $\calc_{nm}(\bfk)=\gd_{nm}$,
from Eqs.~\eqref{eni.2} and \eqref{eni.4}.

%%%%
\subsection{Expressions for 
\texorpdfstring{$(\calv^{\lda,a}_{nm})_{;k^b}$}{Vnonlocal},
\texorpdfstring{$(r^a_{nm})_{;k^b}$}{Vnonlocal}
and \texorpdfstring{$(\calc_{nm})_{;\bfk}$}{Vnonlocal}
}\label{appvnl}

Using Eqs.~\eqref{rnminn}, \eqref{conmri3n}, \eqref{gendevnn}, and
defining 
$
\calt^{\rma\rmb}\equiv[r^{\rmb},\calv^{\lda,\rma}]
\equiv
[r^{\rmb},\calv^\rma]
$
one can show that
\begin{align}\label{nmesn}
(\calv^{\lda,\rma}_{nm})_{;k^{\rmb}}&=
\calt_{nm}^{\rma\rmb}
+i
\sum_{q}
\bigg(
r^{\rmb}_{nq}  
\calv^{\lda,\rma}_{q m}
-
\calv^{\lda,\rma}_{nq}   
r^{\rmb}_{q m}
\bigg)  
+i  
r^{\rmb}_{nm}
\Delta^{\rma}_{mn}
,
\end{align}
where
\begin{eqnarray}\label{tdel}
\Delta^{\rma}_{mn}
=
\calv^{\lda,\rma}_{nn}  
-
\calv^{\lda,\rma}_{mm}  
,
\end{eqnarray} 
\begin{align}\label{tau.1}
\calt_{nm}^{\rma\rmb}
=
\frac{\hbar}{m_e}\gd_{\rma\rmb} 
C_{nm} 
-\hbar 
\sum_q  
L^{\rma\rmb}_{nq} 
C_{qm} 
,
\end{align}   
and
\begin{align}\label{lab}
L_{nm}^{\rma\rmb}
=\frac{i}{\hbar}[r^{\rmb},v^{\nl,\rma}]_{nm}
.
\end{align}  
The matrix elements $L^{\rma\rmb}_{nm}$
are calculated in Appendix \ref{vesnl}.
% is small
%compared to the other terms, thus we neglect it throwout this work.\cite{valerie} 
Notice that
$(v^{\lda,\rma}_{nm})_{;k^{\rmb}}$ is obtained 
from Eq.~\eqref{nmesn} by 
taking 
$\calc(z)=1$ or $C_{nm}=\gd_{nm}$.

To obtain $(r^{\rma}_{nm})_{;k^{\rmb}}$ we use Eq.~\eqref{chon.10} to
write
$(r^{\rma}_{nm})_{;k^{\rmb}}
=(v^{\lda,\rma}_{nm}/i\go^\lda_{nm})_{;k^{\rmb}}
$ and simply apply the chain rule,
\begin{align}\label{rka}
(r^{\rma}_{nm})_{;k^{\rmb}}
&=
T^{\rma\rmb}_{nm}
+
\frac{ 
r^{\rmb}_{nm}
\Delta^{\rma}_{mn}
+r^{\rma}_{nm}
\Delta^{\rmb}_{mn}
}
{\go^\lda_{nm}}
+
\frac{i}{\go^\lda_{nm}}
\sum_{q}
\bigg(
\go^\lda_{q m} 
r^{\rmb}_{nq} 
r^{\rma}_{q m}
-
\go^\lda_{nq} 
r^{\rma}_{nq} 
r^{\rmb}_{q m}
\bigg)
,
\end{align} 
where 
\begin{eqnarray}\label{del}
\Delta^{\rma}_{mn}
=
v^{\lda,\rma}_{nn}  
-
v^{\lda,\rma}_{mm}  
,
\end{eqnarray}
and
\begin{align}\label{tau.1n} 
T_{nm}^{\rma\rmb}
=\frac{\hbar}{m_e}\gd_{ab}\gd_{nm} 
-\hbar L^{\rma\rmb}_{nm} 
.
\end{align}
Eq.~\eqref{rka} generalizes the usual expresion of
$(r^a_{nm})_{;k^b}$ for a local 
Hamiltonian
\cite{aversaPRB95,nastosPRB05,cabellosPRB09,rashkeevPRB98}
to
the case of a
nonlocal Hamiltonian.
Note that the layered term
$\calt^{\rma\rmb}_{nm}$ reduces to $T^{\rma\rmb}_{nm}$
for the full-slab/bulk case.

Again, we use Eqs.~\eqref{rnminn}, \eqref{conmri3n}, and \eqref{gendevnn},
along with $[\bfr,F(\bfr)]=0$, valid for 
and any function $F(\bfr)$, 
to obtain 
\begin{align} 
(\calc_{nm})_{;\bfk}
&=
i 
\sum_{q} 
 \left(\bfr_{nq}
\calc_{qm}
-
\calc_{nq}
\bfr_{qm}
\right) 
+i\bfr_{nm}(\calc_{mm}-\calc_{nn}) 
,
\end{align} 
where we remind the reader that $\bfr_{nm}$ 
is calculated through 
Eq.~\eqref{chon.10} for LDA. 


%%%%
\subsection{
\texorpdfstring{$\calbv^{\nl}_{nm}$}{Vnonlocal},
\texorpdfstring{$\bfv^\nl_{nm}$}{Vnonlocal}, and 
\texorpdfstring{$T^{\rma\rmb}_{nm}$}{[r,vnl]}}
\label{vesnl}

We take Eq.~\eqref{vnl} into Eq.~\eqref{vcali}
and use
$\sum_{\bfG}\ket{\bfk+\bfG}\bra{\bfk+\bfG}=1$, 
with
$\braket{\bfr}{\bfk+\bfG}=(1/\sqrt{\gO})
\mathrm{exp}(i(\bfk+\bfG)\cdot\bfr)$
to obtain,
\begin{align}\label{vnl.5}
\calbv^{\nl}_{nm}(\bfk)&=\frac{1}{2}
\sum_{\bfG}
\Big(
\bra{n\bfk} \calc(z) 
\ket{\bfk+\bfG}\bra{\bfk+\bfG}
\bfv^\nl \ket{m\bfk}
+
\bra{n\bfk}
\bfv^\nl  
\ket{\bfk+\bfG}\bra{\bfk+\bfG}
\calc(z) \ket{m\bfk}
\Big)
\nonumber\\
&=\frac{1}{2 \hbar}
\sum_{\bfG}
\left(
\calf^{\ell*}_{n\bfk}(\bfG) 
H_{m\bfk}(\bfG) 
+
H^*_{n\bfk}(\bfG) 
\calf_{m\bfk}(\bfG) 
\right) 
,
\end{align}  
where 
we have defined  
\begin{align}\label{vnl.10}
\calf_{n\bfk}(\bfG) 
=
\sum_{\bfG'} 
A_{n\bfk}(\bfG') 
\gd_{\bfG_\parallel \bfG'_\parallel}f(G'_\perp-G_\perp) 
,
\end{align} 
\begin{align}\label{vnl.11}
H_{n\bfk}(\bfG)&=
\sum_{\bfG'} 
A_{n\bfk}(\bfG') 
(\nabla_{\bfK}+\nabla_{\bfK'})  
V^\nl(\bfK,\bfK')
,
\end{align}
and $\bfK=\bfk+\bfG$, $\bfK'=\bfk+\bfG'$.
For fully  separable pseudopotentials in the   
Kleinman-Bylander (KB) form,\cite{mottaCMS10,kleinmanPRL82,adolphPRB96}  
the  
matrix elements 
 $\bra{\bfK}  
V^\nl  
\ket{\bfK'}
=V^\nl(\bfK,\bfK')  
$ 
and their $\bfK$ and $\bfK'$ gradient 
can be readily calculated.\cite{mottaCMS10,adolphPRB96,gordienkoRPJ04,fuchsCPC99} 
We have 
implemented 
the calculation of $\calbv^{\nl}_{nm}(\bfk)$ with the help of 
the \depe~code.\cite{francesco}
We obtain $\bfv^{\nl}_{nm}(\bfk)$ from the previous three 
expressions by taking $\calc(z)=1$, which implies 
that $f(G_\perp)=\gd_{G_\perp 0}$, 
and 
$\calf_{n\bfk}(\bfG) \to F_{n\bfk}(\bfG)=A_{n\bfk}(\bfG)$.

From Eqs.~\eqref{lab} and \eqref{vnl} 
\begin{align}\label{3.1}
L^{\rma\rmb}_{nm}(\bfk) 
=
\frac{1}{\hbar^2}
\bra{n\bfk}
\big[ r^{\rma},[ V^\nl, r^\rmb]\big]
\ket{m\bfk}
,
\end{align} 
and we expand the triple commutator to obtain,
\begin{align}\label{3.5}
L^{\rma\rmb}_{nm}(\bfk) 
&=
\frac{1}{\hbar^2\gO}
\sum_{\bfG,\bfG'} 
A^*_{n\bfk}(\bfK) 
A_{m\bfk}(\bfK')
\int
d\bfr d\bfr'
 e^{-i\bfK\cdot\bfr}
\Big(
r^{\rma}
V^\nl(\bfr,\bfr')
r'^\rmb
-
V^\nl(\bfr,\bfr')
r'^\rma
r'^{\rmb}
\nonumber\\
&-
r^\rmb
r^{\rma}
V^\nl(\bfr,\bfr')
+
 r^\rmb
V^\nl(\bfr,\bfr')
r'^{\rma}
\Big) 
 e^{i\bfK'\cdot\bfr'}
,
\end{align} 
where 
$V^\nl(\bfr,\bfr') = \bra{\bfr} V^\nl\ket{\bfr'}$.
We use the following identity
\begin{align}\label{3.4}
&
\Big(
\frac{\partial^2}{\partial K^\rma\partial K'^\rmb}
+
\frac{\partial^2}{\partial K'^\rma\partial K'^\rmb}
+
\frac{\partial^2}{\partial K^\rma\partial K^\rmb}
+
\frac{\partial^2}{\partial K^\rmb\partial K'^\rma}
\Big)
\int 
d\bfr d\bfr' 
 e^{-i\bfK\cdot\bfr}
V^\nl(\bfr,\bfr') 
e^{i\bfK'\cdot\bfr'}
\nonumber\\
&=
\int d\bfr d\bfr'
 e^{-i\bfK\cdot\bfr}
\Big( 
r^{\rma} 
V^\nl(\bfr,\bfr') 
r'^\rmb
- 
V^\nl(\bfr,\bfr') 
r'^\rma 
r'^{\rmb}
- 
r^\rmb 
r^{\rma} 
V^\nl(\bfr,\bfr')
+
 r^\rmb 
V^\nl(\bfr,\bfr') 
r'^{\rma}
\Big)  
e^{i\bfK'\cdot\bfr'}
,
\end{align}
to write
\begin{align}\label{3.7}
L^{\rma\rmb}_{nm}(\bfk)
&=
\frac{1}{\hbar^2}
\sum_{\bfG,\bfG'} 
A^*_{n\bfk}(\bfK) 
A_{m\bfk}(\bfK')
\Big(
\frac{\partial^2}{\partial K^\rma\partial K'^\rmb}
+
\frac{\partial^2}{\partial K'^\rma\partial K'^\rmb}
+
\frac{\partial^2}{\partial K^\rma\partial K^\rmb}
+
\frac{\partial^2}{\partial K^\rmb\partial K'^\rma}
\Big)
\bra{\bfK} 
V^\nl 
\ket{\bfK'}, 
\nonumber\\
\end{align} 
where
\begin{align}\label{vkk}
\bra{\bfK} 
V^\nl 
\ket{\bfK'} 
=
\frac{1}{\gO}
\int 
d\bfr d\bfr' 
 e^{-i\bfK\cdot\bfr}
V^\nl(\bfr,\bfr') 
e^{i\bfK'\cdot\bfr'}
,
\end{align}
The double derivatives with respect to $\bfK$ and $\bfK'$ 
can be worked out explicitly and 
$L^{\rma\rmb}_{nm}(\bfk)$
can be finally calculated.\cite{valerie}

%%%%
\subsection{Expressions for  \texorpdfstring{$\calbv^{S}_{nm}$}{Vnm}
and
\texorpdfstring{$\Big({\calbv}^{S}_{nm}\Big)_{;\bfk}$}{(Vnm);kb}
}\label{calvs} 

From Eq.~\eqref{vcali}
\begin{align}\label{a.3b}
\calbv^{S}_{nm}
&=
\frac{1}{2}\sum_q\left(   
\bfv^S_{nq}\calc_{qm}+\calc_{nq}\bfv^S_{qm}
\right)  
,
\end{align}    
where $\sum_q\ket{q\bfk}\bra{q\bfk}=1$ was used
and $\bfv^S_{nm}$ is given in Eq.~\eqref{chon.2}.
Taking the generalized derivative of Eq.~\eqref{a.3b}
and applying
the chain rule, we obtain
\begin{align}\label{a.3bn}
\left(\calbv^{S}_{nm}\right)_{;\bfk}
&=
\frac{1}{2}\sum_q\left(
(\bfv^S_{nq})_{;\bfk}\calc_{qm}
+    
\bfv^S_{nq}(\calc_{qm})_{;\bfk}
+
(\calc_{nq})_{;\bfk} \bfv^S_{qm}
+
\calc_{nq} (\bfv^S_{qm})_{;\bfk}
\right)  
.
\end{align}    
Again, from
Eq.~\eqref{chon.2}, 
\begin{align}\label{choni.1}
(\bfv^S_{nm})_{;\bfk}=i\gD f_{mn}
(\bfr_{nm})_{;\bfk}
,
\end{align}
a result that is in agreement with Eq. A(6) of Ref.~\onlinecite{cabellosPRB09}.

\newpage
\bibliography{ref}
\end{document}
